using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Windows.Forms;
using MQTTnet;
using MQTTnet.Client;
using MQTTnet.Client.Options;
using System.Threading.Tasks;

namespace ScaryHouse
{
    public partial class Form1 : Form
    {
        private const int NodesPerGroup = 10;
        private List<Label> batteryLabels = new List<Label>();
        private List<Panel> nodeLights = new List<Panel>();
        private IMqttClient mqttClient;

        public Form1()
        {
            InitializeComponent();
        }

        private async void Form1_Load(object sender, EventArgs e)
        {
            // create node controls
            CreateNodeControls(flowGroup1, 0);
            CreateNodeControls(flowGroup2, NodesPerGroup);
            CreateNodeControls(flowGroup3, NodesPerGroup * 2);

            timer1.Start();

            // try auto connect
            await SetupMqttClient();
        }

        private void CreateNodeControls(FlowLayoutPanel panel, int startIndex)
        {
            for (int i = 0; i < NodesPerGroup; i++)
            {
                var container = new Panel();
                container.Width = panel.ClientSize.Width - 25;
                container.Height = 40;

                var light = new Panel();
                light.Width = 24;
                light.Height = 24;
                light.Left = 4;
                light.Top = 8;
                light.BackColor = Color.Red;
                light.BorderStyle = BorderStyle.FixedSingle;

                var lbl = new Label();
                lbl.AutoSize = false;
                lbl.Width = container.Width - 40;
                lbl.Left = 36;
                lbl.Top = 10;
                lbl.Height = 20;
                lbl.Text = $"Node {startIndex + i + 1}: Battery: --%";

                container.Controls.Add(light);
                container.Controls.Add(lbl);
                panel.Controls.Add(container);

                nodeLights.Add(light);
                batteryLabels.Add(lbl);
            }
        }

        private Random rnd = new Random();

        private void timer1_Tick(object sender, EventArgs e)
        {
            // simulate node updates
            for (int i = 0; i < batteryLabels.Count; i++)
            {
                // randomly decide alive
                bool alive = rnd.NextDouble() > 0.2; // 80% alive
                nodeLights[i].BackColor = alive ? Color.LimeGreen : Color.Red;

                int battery = alive ? rnd.Next(30, 100) : rnd.Next(0, 30);
                batteryLabels[i].Text = $"Node {i + 1}: Battery: {battery}%";
            }
        }

        private async Task SetupMqttClient()
        {
            try
            {
                var factory = new MqttFactory();
                mqttClient = factory.CreateMqttClient();

                var options = new MqttClientOptionsBuilder()
                    .WithTcpServer(textBoxBroker.Text)
                    .WithClientId("ScaryHouseClient")
                    .Build();

                mqttClient.UseConnectedHandler(async e =>
                {
                    Invoke(new Action(() =>
                    {
                        buttonConnect.Text = "Connected";
                    }));
                });

                mqttClient.UseDisconnectedHandler(async e =>
                {
                    Invoke(new Action(() =>
                    {
                        buttonConnect.Text = "Connect MQTT";
                    }));
                });

                await mqttClient.ConnectAsync(options);
                Invoke(new Action(() => buttonConnect.Text = "Connected"));
            }
            catch (Exception ex)
            {
                MessageBox.Show("MQTT connect failed: " + ex.Message);
            }
        }

        private async void buttonConnect_Click(object sender, EventArgs e)
        {
            if (mqttClient != null && mqttClient.IsConnected)
            {
                await mqttClient.DisconnectAsync();
                buttonConnect.Text = "Connect MQTT";
                return;
            }

            await SetupMqttClient();
        }

        private void buttonUpdateConfig_Click(object sender, EventArgs e)
        {
            // placeholder for configuration update
            MessageBox.Show("Configuration updated (placeholder)");
        }

        private async void buttonPub1_Click(object sender, EventArgs e)
        {
            await PublishIfConnected("music/group1", "play");
        }

        private async void buttonPub2_Click(object sender, EventArgs e)
        {
            await PublishIfConnected("music/group2", "play");
        }

        private async void buttonPub3_Click(object sender, EventArgs e)
        {
            await PublishIfConnected("music/group3", "play");
        }

        private async Task PublishIfConnected(string topic, string payload)
        {
            if (mqttClient == null || !mqttClient.IsConnected)
            {
                MessageBox.Show("Not connected to MQTT broker");
                return;
            }

            var message = new MqttApplicationMessageBuilder()
                .WithTopic(topic)
                .WithPayload(payload)
                .WithAtLeastOnceQoS()
                .Build();

            await mqttClient.PublishAsync(message);
            MessageBox.Show($"Published to {topic}");
        }
    }
}
