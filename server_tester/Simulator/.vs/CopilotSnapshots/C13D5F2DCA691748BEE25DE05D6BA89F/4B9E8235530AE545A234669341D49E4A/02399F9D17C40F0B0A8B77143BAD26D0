using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using MQTTnet;
using MQTTnet.Client;
using MQTTnet.Protocol;

namespace Simulator
{
    public partial class Form1 : Form
    {

        private IMqttClient _mqttClient;
        // Replace this line:
        // private int playCounter[3] = { 0, 0, 0 };

        // With this corrected array declaration and initialization:
        private int[] playCounter = new int[3] { 0, 0, 0 };

        private void InitMqtt()
        {
            var factory = new MqttFactory();
            _mqttClient = factory.CreateMqttClient();

            // Log connected/disconnected
            _mqttClient.ConnectedAsync += async e =>
            {
                AppendLog("MQTT client connected");
                await Task.CompletedTask;
            };

            _mqttClient.DisconnectedAsync += async e =>
            {
                AppendLog("MQTT client disconnected");
                await Task.CompletedTask;
            };

            // Single, unified incoming-message handler. Ensure UI updates are performed on UI thread.
            _mqttClient.ApplicationMessageReceivedAsync += async e =>
            {
                string topic = e.ApplicationMessage.Topic ?? string.Empty;
                string payload = Encoding.UTF8.GetString(e.ApplicationMessage.PayloadSegment.ToArray());

                // Always log raw incoming messages so you can confirm receipt
                AppendLog($"[RECV] Topic: {topic}\r\nMessage: {payload}");

                // Use BeginInvoke to update UI controls from non-UI thread
                if (this.IsHandleCreated)
                {
                    this.BeginInvoke(new Action(() =>
                    {
                        if (topic == "music/group1")
                        {
                            AppendLog("music/group1 received: " + payload);
                            label1.Text = payload;
                            label4.Text = "Playing";
                            playCounter[0] = 5;
                        }
                        else if (topic == "music/group2")
                        {
                            AppendLog("music/group2 received: " + payload);
                            label2.Text = payload;
                            label5.Text = "Playing";
                            playCounter[1] = 5;
                        }
                        else if (topic == "music/group3")
                        {
                            AppendLog("music/group3 received: " + payload);
                            label3.Text = payload;
                            label6.Text = "Playing";
                            playCounter[2] = 5;
                        }
                    }));
                }

                await Task.CompletedTask;
            };
        }
        public Form1()
        {
            InitializeComponent();
            InitMqtt();
        }

        private async void connectBtn_Click(object sender, EventArgs e)
        {
            var options = new MqttClientOptionsBuilder()
                .WithTcpServer("192.168.1.5", 1883)
                .WithClientId("WinFormsClient-" + Guid.NewGuid())
                .WithCleanSession()
                .Build();

            try
            {
                await _mqttClient.ConnectAsync(options);
                AppendLog("Connected to MQTT broker ✔");

                if (!_mqttClient.IsConnected)
                {
                    AppendLog("Warning: client reports not connected after ConnectAsync.");
                    return;
                }

                // Subscribe specifically to the three topics you want (use explicit topic filter builder)
                var topic1 = new MQTTnet.Client.Subscribing.MqttTopicFilterBuilder()
                    .WithTopic("music/group1")
                    .WithQualityOfServiceLevel(MqttQualityOfServiceLevel.AtLeastOnce)
                    .Build();
                await _mqttClient.SubscribeAsync(topic1);
                AppendLog($"Subscribed to: music/group1");

                var topic2 = new MQTTnet.Client.Subscribing.MqttTopicFilterBuilder()
                    .WithTopic("music/group2")
                    .WithQualityOfServiceLevel(MqttQualityOfServiceLevel.AtLeastOnce)
                    .Build();
                await _mqttClient.SubscribeAsync(topic2);
                AppendLog($"Subscribed to: music/group2");

                var topic3 = new MQTTnet.Client.Subscribing.MqttTopicFilterBuilder()
                    .WithTopic("music/group3")
                    .WithQualityOfServiceLevel(MqttQualityOfServiceLevel.AtLeastOnce)
                    .Build();
                await _mqttClient.SubscribeAsync(topic3);
                AppendLog($"Subscribed to: music/group3");

                // Diagnostic wildcard subscription - remove this after you confirm messages arrive.
                try
                {
                    var wildcard = new MQTTnet.Client.Subscribing.MqttTopicFilterBuilder()
                        .WithTopic("music/#")
                        .WithQualityOfServiceLevel(MqttQualityOfServiceLevel.AtLeastOnce)
                        .Build();
                    await _mqttClient.SubscribeAsync(wildcard);
                    AppendLog("Subscribed to diagnostic wildcard: music/#");
                }
                catch (Exception exWildcard)
                {
                    AppendLog("Wildcard subscribe failed: " + exWildcard.Message);
                }

                timer1.Start();
            }
            catch (Exception ex)
            {
                AppendLog("Connection Failed: " + ex.Message);
            }
        }
        private void AppendLog(string text)
        {
            if (textBox1.InvokeRequired)
            {
                textBox1.BeginInvoke(new Action(() => textBox1.AppendText(text + "\r\n")));
            }
            else
            {
                textBox1.AppendText(text + "\r\n");
            }
        }

        private async void publishToServer(string topic, string message)
        {
            if (_mqttClient == null || !_mqttClient.IsConnected)
            {
                AppendLog("Publish failed: MQTT client not connected");
                return;
            }

            var msg = new MqttApplicationMessageBuilder()
                .WithTopic(topic)
                .WithPayload(message)
                .WithQualityOfServiceLevel(MqttQualityOfServiceLevel.AtLeastOnce)
                .Build();

            await _mqttClient.PublishAsync(msg);
            AppendLog($"Published → Topic: {topic} | {message}");
        }
        private void button1_Click(object sender, EventArgs e)
        {
            publishToServer("status/maindoor","01");
        }

        private void button2_Click(object sender, EventArgs e)
        {
            publishToServer("status/maindoor", "02");
        }

        private void button3_Click(object sender, EventArgs e)
        {
            publishToServer("status/maindoor", "03");
        }

        private void button4_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "01");
        }

        private void button5_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "02");
        }

        private void button6_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "03");
        }

        private void button7_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "04");
        }

        private void button8_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "05");
        }

        private void button9_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "06");
        }

        private void button16_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "07");
        }

        private void button10_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "08");
        }

        private void button11_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "09");
        }

        private void button12_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "10");
        }

        private void button13_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "11");
        }

        private void button14_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "12");
        }

        private void button15_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "13");
        }

        private void button17_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "14");
        }

        private void button23_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "15");
        }

        private void button22_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "16");
        }

        private void button21_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "17");
        }

        private void button20_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "18");
        }

        private void button19_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "19");
        }

        private void button18_Click(object sender, EventArgs e)
        {
            publishToServer("status/eachgate", "20");
        }

        private void timer1_Tick(object sender, EventArgs e)
        {
            if (mainDoorcheckBox.Checked)
            {
                publishToServer("status/maindoor", "00");
            }
            if (checkBox1.Checked)
            {
                publishToServer("status/eachgate1", "00");
            }
            if (checkBox2.Checked)
            {
                publishToServer("status/eachgate2", "00");
            }
            if (checkBox3.Checked)
            {
                publishToServer("status/eachgate3", "00");
            }
            if (checkBox4.Checked)
            {
                publishToServer("status/eachgate4", "00");
            }
            if (checkBox5.Checked)
            {
                publishToServer("status/eachgate5", "00");
            }
            if (checkBox6.Checked)
            {
                publishToServer("status/eachgate6", "00");
            }
            if (checkBox7.Checked)
            {
                publishToServer("status/eachgate7", "00");
            }
            if (checkBox8.Checked)
            {
                publishToServer("status/eachgate8", "00");
            }
            if (checkBox9.Checked)
            {
                publishToServer("status/eachgate9", "00");
            }
            if (checkBox10.Checked)
            {
                publishToServer("status/eachgate10", "00");
            }
            if (checkBox11.Checked)
            {
                publishToServer("status/eachgate11", "00");
            }
            if (checkBox12.Checked)
            {
                publishToServer("status/eachgate12", "00");
            }
            if (checkBox13.Checked)
            {
                publishToServer("status/eachgate13", "00");
            }
            if (checkBox14.Checked)
            {
                publishToServer("status/eachgate14", "00");
            }
            if (checkBox15.Checked)
            {
                publishToServer("status/eachgate15", "00");
            }
            if (checkBox16.Checked)
            {
                publishToServer("status/eachgate16", "00");
            }
            if (checkBox17.Checked)
            {
                publishToServer("status/eachgate17", "00");
            }
            if (checkBox18.Checked)
            {
                publishToServer("status/eachgate18", "00");
            }
            if (checkBox19.Checked)
            {
                publishToServer("status/eachgate19", "00");
            }
            if (checkBox20.Checked)
            {
                publishToServer("status/eachgate20", "00");
            }
            if(checkBox21.Checked)
            {
                publishToServer("status/group1", "12:23:45:56:45:301,00.00");
                publishToServer("status/group1", "12:23:45:56:45:311,00.00");
                publishToServer("status/group1", "12:23:45:56:45:321,00.00");
                publishToServer("status/group1", "12:23:45:56:45:331,00.00");
                publishToServer("status/group1", "12:23:45:56:45:341,00.00");
            }
            if (checkBox22.Checked)
            {
                publishToServer("status/group2", "12:23:45:56:45:302,00.00");
                publishToServer("status/group2", "12:23:45:56:45:312,00.00");
                publishToServer("status/group2", "12:23:45:56:45:322,00.00");
                publishToServer("status/group2", "12:23:45:56:45:332,00.00");
                publishToServer("status/group2", "12:23:45:56:45:342,00.00");
            }
            if (checkBox23.Checked)
            {
                publishToServer("status/group3", "12:23:45:56:45:303,00.00");
                publishToServer("status/group3", "12:23:45:56:45:313,00.00");
                publishToServer("status/group3", "12:23:45:56:45:323,00.00");
                publishToServer("status/group3", "12:23:45:56:45:333,00.00");
                publishToServer("status/group3", "12:23:45:56:45:343,00.00");
            }
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            label4.Text = "Not Playing";
            label5.Text = "Not Playing";
            label6.Text = "Not Playing";
        }

        private void button24_Click(object sender, EventArgs e)
        {
            checkBox1.Checked = false;
            checkBox2.Checked = false;
            checkBox3.Checked = false;
            checkBox4.Checked = false;
            checkBox5.Checked = false;
            checkBox6.Checked = false;
            checkBox7.Checked = false;
            checkBox8.Checked = false;
            checkBox9.Checked = false;
            checkBox10.Checked = false;
            checkBox11.Checked = false;
            checkBox12.Checked = false;
            checkBox13.Checked = false;
            checkBox14.Checked = false;
            checkBox15.Checked = false;
            checkBox16.Checked = false;
            checkBox17.Checked = false;
            checkBox18.Checked = false;
            checkBox19.Checked = false;
            checkBox20.Checked = false;
            mainDoorcheckBox.Checked = false;
        }

        private void button25_Click(object sender, EventArgs e)
        {
            checkBox1.Checked = true;
            checkBox2.Checked = true;
            checkBox3.Checked = true;
            checkBox4.Checked = true;
            checkBox5.Checked = true;
            checkBox6.Checked = true;
            checkBox7.Checked = true;
            checkBox8.Checked = true;
            checkBox9.Checked = true;
            checkBox10.Checked = true;
            checkBox11.Checked = true;
            checkBox12.Checked = true;
            checkBox13.Checked = true;
            checkBox14.Checked = true;
            checkBox15.Checked = true;
            checkBox16.Checked = true;
            checkBox17.Checked = true;
            checkBox18.Checked = true;
            checkBox19.Checked = true;
            checkBox20.Checked = true;
            mainDoorcheckBox.Checked = true;
        }

        private void timer2_Tick(object sender, EventArgs e)
        {
            if (playCounter[0] == 0)
            {
                label4.Text = "Not Playing";
                label4.BackColor = Color.Gray;
            }
            else
            {
                label4.Text = "Playing";
                playCounter[0]--;
                label4.BackColor = Color.LightGreen;
            }
            if (playCounter[1] == 0)
            {
                label5.Text = "Not Playing";
                label5.BackColor = Color.Gray;
            }
            else
            {
                label5.Text = "Playing";
                playCounter[1]--;
                label5.BackColor = Color.LightGreen;
            }
            if (playCounter[2] == 0)
            {
                label6.Text = "Not Playing";
                label6.BackColor = Color.Gray;
            }
            else
            {
                label6.Text = "Playing";
                playCounter[2]--;
                label6.BackColor = Color.LightGreen;
            }
        }
    }
}
